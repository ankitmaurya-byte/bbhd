<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stacked Bar Chart</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      svg {
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div id="chart"></div>

    <script>
      const data = [
        { state: "Bangalore", age: ">45", population: 8 },
        { state: "Bangalore", age: "0-5", population: 22 },
        { state: "Bangalore", age: "11-15", population: 16 },
        { state: "Bangalore", age: "16-20", population: 16 },
        { state: "Bangalore", age: "21-30", population: 12 },
        { state: "Bangalore", age: "31-45", population: 2 },
        { state: "Bangalore", age: "6-10", population: 24 },
        { state: "Bhiwandi", age: ">45", population: 8 },
        { state: "Bhiwandi", age: "0-5", population: 18 },
        { state: "Bhiwandi", age: "11-15", population: 16 },
        { state: "Bhiwandi", age: "16-20", population: 8 },
        { state: "Bhiwandi", age: "21-30", population: 14 },
        { state: "Bhiwandi", age: "31-45", population: 2 },
        { state: "Bhiwandi", age: "6-10", population: 34 },
        { state: "Chandigarh", age: ">45", population: 12 },
        { state: "Chandigarh", age: "0-5", population: 20 },
        { state: "Chandigarh", age: "11-15", population: 12 },
        { state: "Chandigarh", age: "16-20", population: 16 },
        { state: "Chandigarh", age: "21-30", population: 20 },
        { state: "Chandigarh", age: "31-45", population: 4 },
        { state: "Chandigarh", age: "6-10", population: 16 },
        // Add remaining states data similarly...
      ];

      const width = 928;
      const marginTop = 30,
        marginRight = 20,
        marginBottom = 0,
        marginLeft = 30;

      const series = d3
        .stack()
        .keys([...new Set(data.map((d) => d.age))])
        .value(([, D], key) => D.find((d) => d.age === key).population)(
        d3.group(data, (d) => d.state)
      );

      const height = series[0].length * 25 + marginTop + marginBottom;

      const x = d3
        .scaleLinear()
        .domain([0, d3.max(series, (d) => d3.max(d, (d) => d[1]))])
        .range([marginLeft, width - marginRight]);

      const y = d3
        .scaleBand()
        .domain(
          d3.groupSort(
            data,
            (D) =>
              -D.find((d) => d.age === "0-5").population /
              d3.sum(D, (d) => d.population),
            (d) => d.state
          )
        )
        .range([marginTop, height - marginBottom])
        .padding(0.08);

      const color = d3
        .scaleOrdinal()
        .domain(series.map((d) => d.key))
        .range(d3.schemeSpectral[series.length])
        .unknown("#ccc");

      const formatValue = (x) => (isNaN(x) ? "N/A" : x.toLocaleString("en"));

      const svg = d3
        .create("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [0, 0, width, height])
        .attr("style", "max-width: 100%; height: auto;");

      svg
        .append("g")
        .selectAll()
        .data(series)
        .join("g")
        .attr("fill", (d) => color(d.key))
        .selectAll("rect")
        .data((D) => D.map((d) => ((d.key = D.key), d)))
        .join("rect")
        .attr("x", (d) => x(d[0]))
        .attr("y", (d) => y(d.data[0]))
        .attr("height", y.bandwidth())
        .attr("width", (d) => x(d[1]) - x(d[0]))
        .append("title")
        .text(
          (d) => `${d.data[0]} ${d.key}\n${formatValue(d.data[1].population)}`
        );

      svg
        .append("g")
        .attr("transform", `translate(0,${marginTop})`)
        .call(d3.axisTop(x).ticks(width / 100, "%"))
        .call((g) => g.selectAll(".domain").remove());

      svg
        .append("g")
        .attr("transform", `translate(${marginLeft},0)`)
        .call(d3.axisLeft(y).tickSizeOuter(0))
        .call((g) => g.selectAll(".domain").remove());

      document.getElementById("chart").appendChild(svg.node());
    </script>
  </body>
</html>
